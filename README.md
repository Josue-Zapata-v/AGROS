<p align="center"><a href="https://laravel.com" target="_blank"><img src="https://raw.githubusercontent.com/laravel/art/master/logo-lockup/5%20SVG/2%20CMYK/1%20Full%20Color/laravel-logolockup-cmyk-red.svg" width="400" alt="Laravel Logo"></a></p>

<p align="center">
<a href="https://github.com/laravel/framework/actions"><img src="https://github.com/laravel/framework/workflows/tests/badge.svg" alt="Build Status"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/dt/laravel/framework" alt="Total Downloads"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/v/laravel/framework" alt="Latest Stable Version"></a>
<a href="https://packagist.org/packages/laravel/framework"><img src="https://img.shields.io/packagist/l/laravel/framework" alt="License"></a>
</p>

## About Laravel

Laravel is a web application framework with expressive, elegant syntax. We believe development must be an enjoyable and creative experience to be truly fulfilling. Laravel takes the pain out of development by easing common tasks used in many web projects, such as:

- [Simple, fast routing engine](https://laravel.com/docs/routing).
- [Powerful dependency injection container](https://laravel.com/docs/container).
- Multiple back-ends for [session](https://laravel.com/docs/session) and [cache](https://laravel.com/docs/cache) storage.
- Expressive, intuitive [database ORM](https://laravel.com/docs/eloquent).
- Database agnostic [schema migrations](https://laravel.com/docs/migrations).
- [Robust background job processing](https://laravel.com/docs/queues).
- [Real-time event broadcasting](https://laravel.com/docs/broadcasting).

Laravel is accessible, powerful, and provides tools required for large, robust applications.

## Learning Laravel

Laravel has the most extensive and thorough [documentation](https://laravel.com/docs) and video tutorial library of all modern web application frameworks, making it a breeze to get started with the framework.

You may also try the [Laravel Bootcamp](https://bootcamp.laravel.com), where you will be guided through building a modern Laravel application from scratch.

If you don't feel like reading, [Laracasts](https://laracasts.com) can help. Laracasts contains thousands of video tutorials on a range of topics including Laravel, modern PHP, unit testing, and JavaScript. Boost your skills by digging into our comprehensive video library.

## Laravel Sponsors

We would like to extend our thanks to the following sponsors for funding Laravel development. If you are interested in becoming a sponsor, please visit the [Laravel Partners program](https://partners.laravel.com).

### Premium Partners

- **[Vehikl](https://vehikl.com)**
- **[Tighten Co.](https://tighten.co)**
- **[Kirschbaum Development Group](https://kirschbaumdevelopment.com)**
- **[64 Robots](https://64robots.com)**
- **[Curotec](https://www.curotec.com/services/technologies/laravel)**
- **[DevSquad](https://devsquad.com/hire-laravel-developers)**
- **[Redberry](https://redberry.international/laravel-development)**
- **[Active Logic](https://activelogic.com)**

## Contributing

Thank you for considering contributing to the Laravel framework! The contribution guide can be found in the [Laravel documentation](https://laravel.com/docs/contributions).

## Code of Conduct

In order to ensure that the Laravel community is welcoming to all, please review and abide by the [Code of Conduct](https://laravel.com/docs/contributions#code-of-conduct).

## Security Vulnerabilities

If you discover a security vulnerability within Laravel, please send an e-mail to Taylor Otwell via [taylor@laravel.com](mailto:taylor@laravel.com). All security vulnerabilities will be promptly addressed.

## License

The Laravel framework is open-sourced software licensed under the [MIT license](https://opensource.org/licenses/MIT).



------------------
AGROS
# Estructura de Carpetas del Proyecto Agros

```
AGROS/
‚îÇ
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ Console/
‚îÇ   ‚îú‚îÄ‚îÄ Exceptions/
‚îÇ   ‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Middleware/
‚îÇ   ‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îî‚îÄ‚îÄ Providers/
‚îÇ
‚îú‚îÄ‚îÄ bootstrap/
‚îÇ
‚îú‚îÄ‚îÄ config/
‚îÇ
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ factories/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îî‚îÄ‚îÄ seeders/
‚îÇ
‚îú‚îÄ‚îÄ public/
‚îÇ
‚îú‚îÄ‚îÄ resources/
‚îÇ   ‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îî‚îÄ‚îÄ views/
‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îî‚îÄ‚îÄ layouts/
‚îÇ
‚îú‚îÄ‚îÄ routes/
‚îÇ
‚îú‚îÄ‚îÄ storage/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ framework/
‚îÇ   ‚îî‚îÄ‚îÄ logs/
‚îÇ
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ Feature/
‚îÇ   ‚îî‚îÄ‚îÄ Unit/
‚îÇ
‚îú‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ artisan
‚îú‚îÄ‚îÄ composer.json
‚îú‚îÄ‚îÄ composer.lock
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ phpunit.xml
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ tailwind.config.js
‚îî‚îÄ‚îÄ vite.config.js
```
---

## üìÇ Controlador: `ProductoController.php`

**Ubicaci√≥n:**
`app/Http/Controllers/Agricultor/ProductoController.php`

**Prop√≥sito:**
Este controlador gestiona todas las acciones CRUD relacionadas a los productos que publica un agricultor autenticado.

---

### üìå Funciones Definidas

#### 1. `index()`

**Funci√≥n:** Muestra todos los productos publicados por el agricultor autenticado.

```php
$productos = Producto::where('agricultor_id', auth()->id())->get();
return view('agricultor.dashboard', compact('productos'));
```

**Vista:**
`resources/views/agricultor/dashboard.blade.php`

‚úÖ **Comentario:** Correcto y espec√≠fico. Se filtran productos por agricultor autenticado.

---

#### 2. `create()`

**Funci√≥n:** Retorna la vista para crear un nuevo producto.

**Vista:**
`resources/views/agricultor/productos/create.blade.php`

‚úÖ **Comentario:** Vista separada para formulario de creaci√≥n. Correcto.

---

#### 3. `store(Request $request)`

**Funci√≥n:**
Valida, guarda la imagen (si existe), agrega el `agricultor_id`, y crea el nuevo producto.

**Redirecci√≥n:**
`redirect()->route('agricultor.dashboard')`

‚úÖ **Comentario:** Implementaci√≥n correcta con uso de `store()` y validaci√≥n centralizada.

‚ö†Ô∏è **Sugerencia futura leve:** Si se desea m√°s limpieza de c√≥digo, se puede extraer la l√≥gica de manejo de imagen a un m√©todo separado (`procesarImagen()`).

---

#### 4. `edit($id)`

**Funci√≥n:**
Busca el producto por ID, validando que sea del agricultor autenticado. Retorna la vista de edici√≥n.

**Vista:**
`resources/views/agricultor/productos/edit.blade.php`

‚úÖ Correcto. La validaci√≥n de pertenencia del producto est√° bien aplicada.

---

#### 5. `update(Request $request, $id)`

**Funci√≥n:**
Similar a `store()`. Valida y actualiza el producto, incluyendo reemplazo de imagen si se sube una nueva.

‚úÖ Correcto.

üîç **Observaci√≥n ligera:** Podr√≠a implementarse limpieza de imagen anterior si se actualiza una nueva (aunque no es obligatorio en este punto del desarrollo).

---

#### 6. `destroy($id)`

**Funci√≥n:**
Elimina un producto despu√©s de validar que pertenece al agricultor autenticado.

‚úÖ Correcto.

üìå **Mejora futura opcional:** Eliminar la imagen del almacenamiento si se borra el producto. Se puede usar `Storage::delete($producto->imagen)` si lo implementas m√°s adelante.

---

### üîß M√©todos Auxiliares

#### `validarProducto(Request $request)`

**Funci√≥n:**
Valida campos como nombre, precio, stock, peso m√≠nimo y m√°ximo, imagen, etc.

‚úÖ Est√° bien segmentado. La regla `'gte:min_kg_envio'` es clave y bien usada.

---

#### `obtenerProducto($id)`

**Funci√≥n:**
Consulta un producto que sea propiedad del agricultor autenticado.

‚úÖ Correcto, buen uso de `firstOrFail()` para manejo de errores.

---

### ‚úÖ Resumen Documental de `ProductoController`

| M√©todo          | Prop√≥sito                                 | Vista asociada                          |
| --------------- | ----------------------------------------- | --------------------------------------- |
| index           | Mostrar productos del agricultor          | `agricultor/dashboard.blade.php`        |
| create          | Formulario de creaci√≥n de producto        | `agricultor/productos/create.blade.php` |
| store           | Validar y guardar nuevo producto          | redirige al dashboard                   |
| edit            | Formulario para editar producto existente | `agricultor/productos/edit.blade.php`   |
| update          | Validar y actualizar producto             | redirige al dashboard                   |
| destroy         | Eliminar un producto                      | redirige al dashboard                   |
| validarProducto | Validar los campos del formulario         | N/A                                     |
| obtenerProducto | Verificar pertenencia del producto        | N/A                                     |

---

### üö® Posibles mejoras futuras (sin urgencia)

| Aspecto                 | Mejora sugerida                                        |
| ----------------------- | ------------------------------------------------------ |
| Imagen                  | Eliminar imagen anterior al actualizar o borrar.       |
| C√≥digo m√°s limpio       | Extraer el manejo de imagen a m√©todo auxiliar.         |
| Reutilizaci√≥n de vistas | Considerar partials para el formulario (crear/editar). |

---

## üìÇ Controlador: `PerfilController.php`

**Ubicaci√≥n:**
`app/Http/Controllers/Agricultor/PerfilController.php`

**Prop√≥sito general:**
Este controlador permite que el agricultor **visualice y edite su perfil personal**, incluyendo nombre, tel√©fono y direcci√≥n.

---

### üìå Funciones Definidas

---

#### 1. `edit()`

**Descripci√≥n:**
Obtiene el usuario autenticado (agricultor) y carga la vista con sus datos personales para ser editados.

**C√≥digo relevante:**

```php
$usuario = Auth::user();
return view('agricultor.perfil', compact('usuario'));
```

**Vista asociada:**
`resources/views/agricultor/perfil.blade.php`

‚úÖ **Comentario:** Implementaci√≥n directa y clara. Se usa el helper de autenticaci√≥n para obtener al usuario actual.

---

#### 2. `update(Request $request)`

**Descripci√≥n:**
Valida y actualiza los datos personales del agricultor (nombre, tel√©fono, direcci√≥n).

**Validaciones aplicadas:**

```php
$request->validate([
    'name' => 'required|string|max:100',
    'phone' => 'nullable|string|max:20',
    'direccion' => 'nullable|string|max:255',
]);
```

**Acci√≥n de actualizaci√≥n:**

```php
$usuario->update([
    'name' => $request->name,
    'phone' => $request->phone,
    'direccion' => $request->direccion,
]);
```

**Redirecci√≥n:**
`redirect()->route('agricultor.perfil')`

‚úÖ **Comentario:** La actualizaci√≥n est√° bien protegida por validaci√≥n. Solo se permiten campos que el agricultor puede y debe modificar.

üìå **Nota t√©cnica futura (opcional):** Si en alg√∫n momento se permite actualizar el correo o contrase√±a, se deber√° manejar por separado con validaci√≥n m√°s estricta.

---

### ‚úÖ Resumen Documental de `PerfilController`

| M√©todo | Prop√≥sito                               | Vista asociada                     |
| ------ | --------------------------------------- | ---------------------------------- |
| edit   | Mostrar formulario de edici√≥n de perfil | `agricultor/perfil.blade.php`      |
| update | Validar y actualizar datos personales   | redirige a la misma ruta con √©xito |

---

### üîê Seguridad

* ‚úÖ Ambos m√©todos solo funcionan para el usuario autenticado actual (`Auth::user()`).
* ‚úÖ El uso del m√©todo `update()` asegura que **solo se modifiquen los campos permitidos**.

---

### üõ† Posibles mejoras futuras (sin urgencia)

| Mejora sugerida                                | Justificaci√≥n                    |
| ---------------------------------------------- | -------------------------------- |
| Agregar validaci√≥n de formato para el tel√©fono | Asegura coherencia en la entrada |
| Mostrar confirmaci√≥n con un modal              | Mejor UX en la edici√≥n de perfil |
| Soporte para imagen de perfil (avatar)         | Mejora visual y personalizaci√≥n  |

---

## üìÇ Controlador: `PedidoController.php`

**Ubicaci√≥n:**
`app/Http/Controllers/Agricultor/PedidoController.php`

**Prop√≥sito general:**
Este controlador permite al agricultor **visualizar los pedidos que han realizado los compradores** sobre sus productos. Muestra los detalles del pedido y el comprador relacionado.

---

### üìå Funciones Definidas

---

#### 1. `index()`

**Descripci√≥n:**
Obtiene todos los pedidos dirigidos al agricultor autenticado. Carga adem√°s las relaciones necesarias para mostrar informaci√≥n completa:

* **Relaciones incluidas:**

  * `detalles.producto`: para saber qu√© productos se han solicitado y sus datos.
  * `comprador`: para saber qui√©n hizo el pedido.

**C√≥digo clave:**

```php
$pedidos = Pedido::with(['detalles.producto', 'comprador'])
    ->where('agricultor_id', Auth::id())
    ->latest()
    ->get();
```

**Vista asociada:**
`resources/views/agricultor/pedidos/index.blade.php`

‚úÖ **Comentario:** Excelente uso de **Eloquent eager loading** (`with`) para evitar el problema de N+1 consultas. Adem√°s, el filtro `where('agricultor_id', Auth::id())` garantiza que solo se muestren pedidos del agricultor autenticado.

---

### ‚úÖ Resumen Documental de `PedidoController`

| M√©todo | Prop√≥sito                                         | Vista asociada                       |
| ------ | ------------------------------------------------- | ------------------------------------ |
| index  | Listar pedidos recibidos por el agricultor actual | `agricultor/pedidos/index.blade.php` |

---

### üîÑ Relaciones esperadas

Este controlador espera que existan correctamente definidas las siguientes relaciones en los modelos:

#### Modelo `Pedido`

```php
public function detalles()
{
    return $this->hasMany(DetallePedido::class);
}

public function comprador()
{
    return $this->belongsTo(User::class, 'comprador_id');
}
```

#### Modelo `DetallePedido`

```php
public function producto()
{
    return $this->belongsTo(Producto::class);
}
```

‚úÖ Si estas relaciones est√°n correctamente definidas en tus modelos, todo el flujo de datos deber√≠a funcionar sin problemas.

---

### üõ† Posibles mejoras futuras (sin urgencia)

| Mejora sugerida                                   | Justificaci√≥n                                      |
| ------------------------------------------------- | -------------------------------------------------- |
| Paginaci√≥n con `paginate()`                       | Si hay muchos pedidos, evitar√° sobrecarga de vista |
| Filtros por estado del pedido (`pendiente`, etc.) | Facilita b√∫squeda r√°pida de pedidos espec√≠ficos    |
| Colores o badges seg√∫n estado                     | Mejora visual para seguimiento r√°pido              |

---


## üìÇ Controlador: `PostulacionTransportistaController.php`

**Ubicaci√≥n:**
`app/Http/Controllers/Agricultor/PostulacionTransportistaController.php`

**Prop√≥sito general:**
Este controlador permite al agricultor visualizar las **postulaciones de transportistas** para sus pedidos y **aceptar o rechazar** cada postulaci√≥n.

---

### üìå Funciones Definidas

---

#### 1. `index()`

**Descripci√≥n:**
Muestra todas las postulaciones hechas por transportistas a los pedidos del agricultor autenticado.

**L√≥gica:**

* Carga con `with()` las relaciones:

  * `pedido`: para obtener el pedido al que se postulan.
  * `transportista`: para conocer qui√©n se postul√≥.
* Filtra solo postulaciones de pedidos cuyo `agricultor_id` coincide con el usuario autenticado.
* Ordena de m√°s reciente a m√°s antigua.

**C√≥digo clave:**

```php
$postulaciones = PostulacionTransportista::with(['pedido', 'transportista'])
    ->whereHas('pedido', function ($query) {
        $query->where('agricultor_id', Auth::id());
    })
    ->orderBy('created_at', 'desc')
    ->get();
```

**Vista asociada:**
`resources/views/agricultor/postulaciones/index.blade.php`

‚úÖ **Comentario:** Eloquent est√° bien utilizado. Se evita cargar informaci√≥n innecesaria gracias al `whereHas`.

---

#### 2. `responder(Request $request, $id)`

**Descripci√≥n:**
Permite al agricultor **aceptar o rechazar** una postulaci√≥n de transporte.

**Validaci√≥n del request:**

```php
$request->validate([
    'accion' => 'required|in:aceptar,rechazar',
]);
```

**Seguridad:**
Se valida que la postulaci√≥n pertenezca a un pedido del agricultor actual mediante `whereHas`.

**Acci√≥n:**
Se actualiza el campo `estado` a `'aceptado'` o `'rechazado'`.

**Redirecci√≥n:**
`redirect()->route('agricultor.postulaciones')`

‚úÖ **Comentario:** Correctamente protegido contra acceso indebido y con l√≥gica clara.

üìå **Nota futura:** Si se desea agregar notificaciones (correo o alerta en sistema) al transportista, este es el lugar donde hacerlo.

---

### ‚úÖ Resumen Documental de `PostulacionTransportistaController`

| M√©todo    | Prop√≥sito                                            | Vista asociada                                  |
| --------- | ---------------------------------------------------- | ----------------------------------------------- |
| index     | Listar postulaciones de transportistas a los pedidos | `agricultor/postulaciones/index.blade.php`      |
| responder | Aceptar o rechazar una postulaci√≥n                   | redirige a `agricultor.postulaciones` con flash |

---

### üîÑ Relaciones esperadas

#### Modelo `PostulacionTransportista`

```php
public function pedido()
{
    return $this->belongsTo(Pedido::class);
}

public function transportista()
{
    return $this->belongsTo(User::class, 'transportista_id');
}
```

#### Modelo `Pedido`

(Ya documentado anteriormente)

---

### üõ† Posibles mejoras futuras (sin urgencia)

| Mejora sugerida                            | Justificaci√≥n                                                         |
| ------------------------------------------ | --------------------------------------------------------------------- |
| Aceptar solo una postulaci√≥n por pedido    | Reforzar l√≥gica de negocio (actualmente no est√° en este controlador). |
| Mensaje personalizado al rechazar          | Mejora la comunicaci√≥n con el transportista.                          |
| Notificaci√≥n al transportista (correo/app) | Mejora experiencia e interacci√≥n.                                     |
| Historial de decisiones                    | Para auditor√≠a futura o trazabilidad.                                 |

---
app\Http\Controllers\Auth:
El cual contiene:
AuthenticatedSessionController.php
ConfirmablePasswordController.php
EmailVerificationNotificationController.php
EmailVerificationPromptController.php
NewPasswordController.php
PasswordController.php
PasswordResetLinkController.php
RegisteredUserController.php
VerifyEmailController.php

---

## üìÇ Controlador: `AuthenticatedSessionController.php`

**Ubicaci√≥n:**
`app/Http/Controllers/Auth/AuthenticatedSessionController.php`

**Prop√≥sito general:**
Este controlador gestiona el **inicio de sesi√≥n (login)** y el **cierre de sesi√≥n (logout)** en la plataforma AGROS. Adem√°s, redirige a cada usuario autenticado a su respectivo dashboard seg√∫n su rol (`agricultor`, `comprador`, `transportista`).

---

### üìå Funciones Definidas

---

#### 1. `create()`

**Descripci√≥n:**
Muestra la vista del formulario de inicio de sesi√≥n.

**Vista asociada:**
`resources/views/auth/login.blade.php`

**Tipo de respuesta:**
`Illuminate\View\View`

‚úÖ **Comentario:** L√≥gica simple y correcta. Carga la vista de login.

---

#### 2. `store(LoginRequest $request)`

**Descripci√≥n:**
Autentica al usuario seg√∫n las credenciales proporcionadas. Redirige al dashboard correspondiente seg√∫n su rol.

**Flujo:**

1. Valida las credenciales mediante el objeto `LoginRequest`.
2. Regenera la sesi√≥n para prevenir ataques de fijaci√≥n de sesi√≥n.
3. Eval√∫a el rol del usuario autenticado y redirige seg√∫n corresponda:

   * `'agricultor' ‚Üí agricultor.dashboard`
   * `'comprador' ‚Üí comprador.dashboard`
   * `'transportista' ‚Üí transportista.dashboard`
4. Si el rol no es v√°lido, se cierra la sesi√≥n y se muestra un error.

**Tipo de respuesta:**
`Illuminate\Http\RedirectResponse`

‚úÖ **Comentario:** Buena pr√°ctica el uso de `regenerate()` para seguridad de sesi√≥n. Correcto el uso de `switch` para manejar roles.

üìå **Nota de mejora futura:** Si se agregan m√°s roles, se deber√≠a externalizar esta l√≥gica en un **RedirectService** para mantener limpio este controlador.

---

#### 3. `destroy(Request $request)`

**Descripci√≥n:**
Finaliza la sesi√≥n del usuario y lo redirige a la p√°gina de inicio.

**Acciones realizadas:**

* Llama a `logout()` del guard `web`.
* Invalida la sesi√≥n actual.
* Regenera el token CSRF.
* Redirige al home `/`.

‚úÖ **Comentario:** Excelente implementaci√≥n est√°ndar para logout seguro en Laravel.

---

### ‚úÖ Resumen Documental de `AuthenticatedSessionController`

| M√©todo  | Prop√≥sito                        | Vista/Ruta asociada                                                |
| ------- | -------------------------------- | ------------------------------------------------------------------ |
| create  | Mostrar formulario de login      | `auth/login.blade.php`                                             |
| store   | Autenticar y redirigir seg√∫n rol | `dashboard` seg√∫n rol (`agricultor`, `comprador`, `transportista`) |
| destroy | Cerrar sesi√≥n                    | Redirige a `/`                                                     |

---

### üîê Seguridad

* ‚úÖ `LoginRequest` garantiza autenticaci√≥n segura y validada.
* ‚úÖ Regeneraci√≥n de sesi√≥n al iniciar y al cerrar sesi√≥n.
* ‚úÖ Protecci√≥n contra usuarios con rol no v√°lido.

---

### üõ† Mejora sugerida a futuro (opcional)

| Mejora propuesta                                 | Justificaci√≥n                         |
| ------------------------------------------------ | ------------------------------------- |
| Crear middleware `RedirectIfAuthenticatedByRole` | Centralizar redirecci√≥n por rol       |
| Agregar logging de intentos fallidos             | Seguridad y trazabilidad              |
| Mostrar errores personalizados por rol           | Mejor feedback al usuario en el login |

---
---

## üìÇ Controlador: `ConfirmablePasswordController.php`

**Ubicaci√≥n:**
`app/Http/Controllers/Auth/ConfirmablePasswordController.php`

**Prop√≥sito general:**
Este controlador permite **confirmar la contrase√±a del usuario actual** antes de autorizar acciones sensibles. Forma parte del sistema de seguridad de Laravel para proteger rutas cr√≠ticas.

---

### üìå Funciones Definidas

---

#### 1. `show()`

**Descripci√≥n:**
Muestra la vista donde el usuario debe ingresar nuevamente su contrase√±a para confirmar su identidad.

**Vista asociada:**
`resources/views/auth/confirm-password.blade.php`

**Tipo de respuesta:**
`Illuminate\View\View`

‚úÖ **Comentario:** Correctamente utilizado para proteger accesos sensibles (como configuraci√≥n, edici√≥n de datos cr√≠ticos, etc.)

---

#### 2. `store(Request $request)`

**Descripci√≥n:**
Valida si la contrase√±a ingresada es correcta para el usuario autenticado.

**L√≥gica:**

* Usa `Auth::guard('web')->validate()` para verificar si la contrase√±a coincide con la del usuario actual.
* Si la validaci√≥n falla, lanza una `ValidationException`.
* Si es correcta, guarda en la sesi√≥n el momento de la confirmaci√≥n:

  ```php
  $request->session()->put('auth.password_confirmed_at', time());
  ```
* Redirige a la ruta que se hab√≠a intentado acceder (`intended`).

**Tipo de respuesta:**
`Illuminate\Http\RedirectResponse`

‚úÖ **Comentario:** Implementaci√≥n precisa. Protege la ruta posterior y evita que el usuario la acceda sin confirmar su contrase√±a.

---

### ‚úÖ Resumen Documental de `ConfirmablePasswordController`

| M√©todo | Prop√≥sito                                           | Vista/Ruta asociada                        |
| ------ | --------------------------------------------------- | ------------------------------------------ |
| show   | Mostrar formulario para confirmar la contrase√±a     | `auth/confirm-password.blade.php`          |
| store  | Validar contrase√±a ingresada y continuar navegaci√≥n | Redirige a la ruta protegida originalmente |

---

### üîê Seguridad

* ‚úÖ Se utiliza `Auth::guard()->validate()` para verificaci√≥n directa de credenciales.
* ‚úÖ Protecci√≥n con `ValidationException` en caso de error.
* ‚úÖ Guarda la hora exacta de la confirmaci√≥n en sesi√≥n (`auth.password_confirmed_at`), lo cual permite controlar el tiempo de validez de esa confirmaci√≥n en middleware como `password.confirm`.

---

### üõ† Mejora sugerida a futuro (opcional)

| Mejora propuesta                    | Justificaci√≥n                                         |
| ----------------------------------- | ----------------------------------------------------- |
| Mostrar nombre del m√≥dulo protegido | Aclara al usuario por qu√© se le pide reconfirmar.     |
| Configurar expiraci√≥n en `.env`     | Permitir ajustar la duraci√≥n de la sesi√≥n confirmada. |

---
---

## üìÇ Controlador: `EmailVerificationNotificationController.php`

**Ubicaci√≥n:**
`app/Http/Controllers/Auth/EmailVerificationNotificationController.php`

**Prop√≥sito general:**
Permite a un usuario reenviar manualmente el enlace de **verificaci√≥n de correo electr√≥nico** en caso de no haberlo recibido al registrarse.

---

### üìå Funci√≥n Definida

---

#### `store(Request $request)`

**Descripci√≥n:**
Env√≠a un nuevo correo de verificaci√≥n si el usuario a√∫n no ha confirmado su email.

**L√≥gica:**

1. Verifica si el usuario ya confirm√≥ su correo:

   ```php
   if ($request->user()->hasVerifiedEmail())
   ```

   Si ya est√° verificado, redirige a su `dashboard`.

2. Si no ha verificado el correo:

   * Env√≠a un nuevo enlace con `sendEmailVerificationNotification()`.
   * Devuelve una respuesta con estado flash `'verification-link-sent'`.

**Tipo de respuesta:**
`Illuminate\Http\RedirectResponse`

---

### ‚úÖ Resumen Documental de `EmailVerificationNotificationController`

| M√©todo | Prop√≥sito                                    | Redirecci√≥n / Respuesta                                          |
| ------ | -------------------------------------------- | ---------------------------------------------------------------- |
| store  | Reenviar el enlace de verificaci√≥n de correo | Si ya verificado ‚Üí `dashboard`<br>Si no ‚Üí back con mensaje flash |

---

### üîê Seguridad y Consideraciones

* ‚úÖ Usa `Auth::user()` desde el request, por lo tanto requiere que el usuario est√© autenticado.
* ‚úÖ Buena pr√°ctica: verifica si el email ya fue confirmado antes de reenviar.
* ‚úÖ Evita spam innecesario de correos al no enviar si ya est√° verificado.

---

### üîÅ Comportamiento esperado en la vista

Desde la vista correspondiente (ej. `verify-email.blade.php`), se podr√≠a tener un bot√≥n que dispare esta acci√≥n de forma controlada con un `POST` a la ruta correspondiente, algo como:

```blade
<form method="POST" action="{{ route('verification.send') }}">
    @csrf
    <button type="submit">Reenviar enlace</button>
</form>
```

El mensaje flash `'verification-link-sent'` puede ser usado para mostrar una alerta amigable de que el correo fue reenviado correctamente.

---

### üõ† Mejora sugerida a futuro (opcional)

| Mejora propuesta                             | Justificaci√≥n                                                      |
| -------------------------------------------- | ------------------------------------------------------------------ |
| Agregar l√≠mite de reintentos con throttle    | Evitar abuso (Laravel ya tiene soporte via middleware `throttle`). |
| Mostrar confirmaci√≥n en frontend (alerta UI) | Mejora la experiencia del usuario.                                 |

---

---

## üìÇ Controlador: `EmailVerificationPromptController.php`

**Ubicaci√≥n:**
`app/Http/Controllers/Auth/EmailVerificationPromptController.php`

**Prop√≥sito general:**
Este controlador determina si el usuario debe ver la **pantalla que le solicita verificar su correo electr√≥nico** o si puede continuar hacia su dashboard porque ya est√° verificado.

---

### üìå M√©todo Definido

---

#### `__invoke(Request $request)`

**Descripci√≥n:**
Este controlador usa un √∫nico m√©todo (por eso es "invocable") para mostrar la pantalla `verify-email.blade.php` **solo si el usuario a√∫n no ha verificado su email**.

**L√≥gica:**

1. Comprueba si el usuario ya ha verificado su correo:

   ```php
   $request->user()->hasVerifiedEmail()
   ```

2. Si **s√≠ ha verificado**, lo redirige al `dashboard`.

3. Si **no ha verificado**, muestra la vista `auth.verify-email`.

**Tipo de respuesta:**
`Illuminate\Http\RedirectResponse | Illuminate\View\View`

---

### ‚úÖ Resumen Documental de `EmailVerificationPromptController`

| M√©todo     | Prop√≥sito                                      | Vista/Ruta asociada           |
| ---------- | ---------------------------------------------- | ----------------------------- |
| \_\_invoke | Mostrar pantalla para verificar correo         | `auth/verify-email.blade.php` |
|            | O redirigir al dashboard si ya est√° verificado | Redirige a `dashboard`        |

---

### üîê Seguridad y Middleware

Este controlador debe ser protegido por el middleware `auth` para asegurar que solo usuarios autenticados lleguen a esta vista. Laravel Breeze/Jetstream ya suele incluir esta l√≥gica por defecto en las rutas, como:

```php
Route::get('/verify-email', EmailVerificationPromptController::class)
    ->middleware(['auth'])
    ->name('verification.notice');
```

---

### üìÑ Uso en la vista

El archivo `resources/views/auth/verify-email.blade.php` deber√≠a tener un mensaje indicando que el usuario debe verificar su correo, y posiblemente un bot√≥n para reenviar el correo de verificaci√≥n:

```blade
@if (session('status') === 'verification-link-sent')
    <p>Se ha enviado un nuevo enlace de verificaci√≥n a tu correo electr√≥nico.</p>
@endif

<form method="POST" action="{{ route('verification.send') }}">
    @csrf
    <button type="submit">Reenviar correo</button>
</form>
```

---

### üõ† Mejora sugerida a futuro (opcional)

| Mejora propuesta                          | Justificaci√≥n                                         |
| ----------------------------------------- | ----------------------------------------------------- |
| Mostrar el email del usuario en la vista  | Confirmaci√≥n visual al usuario de qu√© correo revisar. |
| Enlace para cerrar sesi√≥n desde esa vista | Por si se registr√≥ con un correo err√≥neo.             |

---
# Documentaci√≥n de Archivos Relacionados: Registro y Autenticaci√≥n en AGROS

## Archivos Documentados

* `RegisteredUserController.php`
* `auth/register.blade.php`

---

## üìÑ `RegisteredUserController.php`

**Ubicaci√≥n:** `app/Http/Controllers/Auth/`

### Funcionalidad

Este controlador gestiona el proceso de **registro de nuevos usuarios** en la plataforma AGROS. Se encarga de:

1. Mostrar el formulario de registro (`create()`).
2. Validar los datos ingresados por el usuario (`store()`):

   * `name`: requerido, texto, m√°ximo 100 caracteres.
   * `email`: requerido, √∫nico, v√°lido y con m√°ximo 100 caracteres.
   * `password`: requerido, confirmado y con reglas seguras.
   * `phone`: requerido, exactamente 9 d√≠gitos.
   * `direccion`: requerido, hasta 255 caracteres.
   * `role`: requerido, debe ser uno de: agricultor, comprador, transportista.
3. Crear un nuevo registro en la tabla `users`.
4. Autenticar al usuario y redirigirlo al dashboard correspondiente seg√∫n su rol.

### Redirecciones por rol

* Agricultor ‚Üí `agricultor.dashboard`
* Comprador ‚Üí `comprador.dashboard`
* Transportista ‚Üí `transportista.dashboard`

---

## üìÑ `auth/register.blade.php`

**Ubicaci√≥n:** `resources/views/auth/`

### Funcionalidad

Es la vista asociada al formulario de registro. Provee los campos requeridos por `RegisteredUserController` y muestra mensajes de error cuando la validaci√≥n falla.

### Campos del formulario

* **Nombre:** campo de texto obligatorio.
* **Correo electr√≥nico:** campo email obligatorio.
* **Tel√©fono:** campo texto con validaci√≥n para exactamente 9 d√≠gitos.
* **Direcci√≥n:** campo de texto obligatorio.
* **Contrase√±a:** campo password con confirmaci√≥n.
* **Rol:** selector desplegable con opciones `agricultor`, `comprador` y `transportista`.

### Validaci√≥n en frontend

* Se especifican atributos HTML como `required`, `maxlength`, `pattern="\d{9}"`, etc.
* Se usa el componente `x-input-error` para mostrar errores debajo de cada campo.

---

## Relaci√≥n entre ambos archivos

* El archivo `register.blade.php` provee la interfaz que permite a un nuevo usuario enviar sus datos.
* `RegisteredUserController.php` es quien procesa esos datos, valida, guarda y redirige al usuario.
* Ambos trabajan juntos para garantizar un proceso de registro seguro, validado y consistente con la estructura de la base de datos `users`.

---

## Consistencia con la base de datos

Estos archivos trabajan en conjunto con la tabla `users`:

```sql
CREATE TABLE users (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  role ENUM('agricultor', 'comprador', 'transportista') NOT NULL,
  phone VARCHAR(20),
  direccion VARCHAR(255),
  precio_transporte_kg DECIMAL(10,2),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

* Todos los campos utilizados en el formulario y validados en el controlador est√°n definidos en la estructura de esta tabla.
* El campo `precio_transporte_kg` no se establece en el registro inicial ya que solo aplica a usuarios con rol `agricultor`. Este se podr√° completar posteriormente desde su perfil.
----------
---

## üìö M√≥dulo Agricultor ‚Äì Documentaci√≥n T√©cnica

### üéØ Prop√≥sito

El m√≥dulo del **Agricultor** permite registrar productos, gestionar pedidos recibidos, aceptar o rechazar postulaciones de transportistas y editar su perfil. Todo el flujo est√° respaldado por controladores, vistas y rutas espec√≠ficas que trabajan en conjunto.

---

## üîÅ Flujo de ingreso y redirecci√≥n

### üìÑ `AuthenticatedSessionController.php`

**Ubicaci√≥n:** `app/Http/Controllers/Auth/AuthenticatedSessionController.php`
**Funci√≥n:** Autentica al usuario y redirige seg√∫n su rol.

```php
switch ($user->role) {
    case 'agricultor':
        return redirect()->route('agricultor.dashboard');
```

üîó **Relaci√≥n:**

* Redirige a la ruta `agricultor.dashboard`, definida en `routes/web.php`
* Esa ruta apunta a `ProductoController@index`
* Que carga la vista `resources/views/agricultor/dashboard.blade.php`

---

## üåæ Dashboard del Agricultor

### üõ£Ô∏è Ruta Principal

```php
Route::get('/dashboard-agricultor', [ProductoController::class, 'index'])->name('agricultor.dashboard');
```

### üìÑ `ProductoController.php`

**Ubicaci√≥n:** `app/Http/Controllers/Agricultor/ProductoController.php`
**Funci√≥n:**

* Muestra productos publicados del agricultor (`index`)
* Permite crear, editar y eliminar productos.

### üìÑ Vista asociada:

* `resources/views/agricultor/dashboard.blade.php`
* Muestra el listado de productos, bot√≥n para agregar y acciones de editar/eliminar.

üîó **Relaci√≥n:**

* El layout base usado es `layouts/agricultor.blade.php`
* Este layout incluye el **men√∫ lateral de navegaci√≥n**.

---

## üîç Layout y navegaci√≥n

### üìÑ `layouts/agricultor.blade.php`

**Ubicaci√≥n:** `resources/views/layouts/agricultor.blade.php`
**Funci√≥n:**
Define la estructura general del panel agricultor. Incluye:

* Men√∫ lateral con navegaci√≥n a:

  * `agricultor.dashboard` ‚Üí Productos
  * `agricultor.pedidos` ‚Üí Pedidos recibidos
  * `agricultor.postulaciones` ‚Üí Postulaciones de transportistas
  * `agricultor.perfil` ‚Üí Mi perfil
* Secci√≥n principal para cada contenido din√°mico `@yield('content')`.

üîó **Relaci√≥n:**
Todas las vistas del m√≥dulo agricultor extienden este layout con `@extends('layouts.agricultor')`.

---

## üì¶ Pedidos recibidos

### üõ£Ô∏è Ruta

```php
Route::get('/agricultor/pedidos', [PedidoController::class, 'index'])->name('agricultor.pedidos');
```

### üìÑ `PedidoController.php`

**Ubicaci√≥n:** `app/Http/Controllers/Agricultor/PedidoController.php`
**Funci√≥n:**
Obtiene todos los pedidos relacionados a los productos del agricultor autenticado.

üîó **Relaci√≥n:**

* Usa `with(['detalles.producto', 'comprador'])` para mostrar informaci√≥n detallada.
* Vista asociada: `resources/views/agricultor/pedidos/index.blade.php` (deber√≠a existir o crearse).

---

## üöö Postulaciones de transportistas

### üõ£Ô∏è Rutas

```php
Route::get('/agricultor/postulaciones', [PostulacionTransportistaController::class, 'index'])->name('agricultor.postulaciones');
Route::post('/agricultor/postulaciones/{id}/responder', [PostulacionTransportistaController::class, 'responder'])->name('agricultor.postulaciones.responder');
```

### üìÑ `PostulacionTransportistaController.php`

**Ubicaci√≥n:** `app/Http/Controllers/Agricultor/PostulacionTransportistaController.php`
**Funci√≥n:**

* Muestra todas las postulaciones hechas a los pedidos del agricultor.
* Permite aceptar o rechazar la postulaci√≥n.

üîó **Relaci√≥n:**

* Vista: `resources/views/agricultor/postulaciones/index.blade.php` (deber√≠a existir o crearse)

---

## üë§ Mi perfil

### üõ£Ô∏è Rutas

```php
Route::get('/agricultor/perfil', [PerfilController::class, 'edit'])->name('agricultor.perfil');
Route::post('/agricultor/perfil', [PerfilController::class, 'update'])->name('agricultor.perfil.update');
```

### üìÑ `PerfilController.php`

**Ubicaci√≥n:** `app/Http/Controllers/Agricultor/PerfilController.php`
**Funci√≥n:**

* Permite al agricultor ver y editar su perfil.

üîó **Relaci√≥n:**

* Vista: `resources/views/agricultor/perfil.blade.php`

---

## üìù Registro de usuario

### üìÑ `RegisteredUserController.php`

**Ubicaci√≥n:** `app/Http/Controllers/Auth/RegisteredUserController.php`
**Funci√≥n personalizada:**

* Crea el usuario y le asigna un `role` (agricultor, comprador, transportista).
* Valida `name`, `email`, `password`, `phone` (exactamente 9 d√≠gitos) y `direccion`.

üîó **Relaci√≥n con la tabla `users`:**

```sql
CREATE TABLE users (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  role ENUM('agricultor', 'comprador', 'transportista') NOT NULL,
  phone VARCHAR(20),
  direccion VARCHAR(255),
  precio_transporte_kg DECIMAL(10,2),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

## ‚úÖ Conclusi√≥n: Encadenamiento de componentes

| Acci√≥n                      | Ruta                        | Controlador                      | Vista asociada                             |
| --------------------------- | --------------------------- | -------------------------------- | ------------------------------------------ |
| Login                       | `/login`                    | `AuthenticatedSessionController` | -                                          |
| Redirecci√≥n por rol         | `/dashboard`                | Interna en middleware            | Redirige seg√∫n rol                         |
| Dashboard Agricultor        | `/dashboard-agricultor`     | `ProductoController@index`       | `agricultor/dashboard.blade.php`           |
| Crear producto              | `/productos/create`         | `ProductoController@create`      | `agricultor/productos/create.blade.php`    |
| Editar producto             | `/productos/{id}/edit`      | `ProductoController@edit`        | `agricultor/productos/edit.blade.php`      |
| Pedidos recibidos           | `/agricultor/pedidos`       | `PedidoController@index`         | `agricultor/pedidos/index.blade.php`       |
| Postulaciones transportista | `/agricultor/postulaciones` | `PostulacionTransportista@index` | `agricultor/postulaciones/index.blade.php` |
| Perfil agricultor           | `/agricultor/perfil`        | `PerfilController@edit`          | `agricultor/perfil.blade.php`              |

---
